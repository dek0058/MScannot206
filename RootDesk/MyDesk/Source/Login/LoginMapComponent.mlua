@Component
script LoginMapComponent extends Component
	
	@ExecSpace("ClientOnly")
	method void OnBeginPlay()
		local loginEntity = _EntityService:GetEntityByPath("/ui/Login")
		if loginEntity == nil then
			log("LoginEntity를 찾을 수 없습니다: /ui/Login")
		end
		self._T["LoginGroupComponent"] = loginEntity:GetComponent(LoginGroupComponent)
	end

	@ExecSpace("Client")
	method void SetLogin()
		---@type LoginGroupComponent
		local LoginGroupCom = self._T["LoginGroupComponent"]
		if LoginGroupCom == nil then
			_GameServerLogic:Kick(_UserProxy:GetUid(), "LoginGroupComponent를 찾을 수 없습니다", KickReason.WorldError)
			return
		end

		local err = LoginGroupCom:SetLoginLayer()
		if err:IsError() == true then
			_ErrorLogic:PrintErrors(err:ToError())
			_GameServerLogic:Kick(_UserProxy:GetUid(), "로그인 레이어 설정 중 오류 발생", KickReason.WorldError)
			return
		end
	end

	@ExecSpace("Client")
	method void SetCharacterSelection()
		---@type LoginGroupComponent
		local LoginGroupCom = self._T["LoginGroupComponent"]
		if LoginGroupCom == nil then
			_GameServerLogic:Kick(_UserProxy:GetUid(), "LoginGroupComponent를 찾을 수 없습니다", KickReason.WorldError)
			return
		end

		local err = LoginGroupCom:SetCharacterSelectionLayer()
		if err:IsError() == true then
			_ErrorLogic:PrintErrors(err:ToError())
			_GameServerLogic:Kick(_UserProxy:GetUid(), "캐릭터 선택 레이어 설정 중 오류 발생", KickReason.WorldError)
			return
		end
	end

	@ExecSpace("ClientOnly")
	@EventSender("LocalPlayer")
	handler HandleMapEnterEvent(MapEnterEvent e)
		_TransitionLogic:Pop()

		if e.needLogin == true then
			self:SetLogin()
		else
			self:SetCharacterSelection()
		end
	end

	@ExecSpace("ClientOnly")
	@EventSender("LocalPlayer")
	handler HandleLoginCompleteEvent(LoginCompleteEvent e)
		self:SetCharacterSelection()
	end
	
	@ExecSpace("ClientOnly")
	@EventSender("LocalPlayer")
	handler HandleLoginFailureEvent(LoginFailureEvent e)
		_ErrorLogic:Throw(e.errorCode)
		
		---@type LoginGroupComponent
		local LoginGroupCom = self._T["LoginGroupComponent"]
		if LoginGroupCom == nil then
			_GameServerLogic:Kick(_UserProxy:GetUid(), "LoginLayerComponent를 찾을 수 없습니다", KickReason.WorldError)
			return
		end
		LoginGroupCom.LoginLayerCom:LoginFailure()
	end

	@ExecSpace("ClientOnly")
	@EventSender("LocalPlayer")
	handler HandleCreateCharacterFailureEvent(CreateCharacterFailureEvent e)
		_ErrorLogic:Throw(e.errorCode)

		-- 유저를 찾을 수 없다는 오류면 로그인 화면으로 이동
		local loginRequired = e.errorCode == _ErrorLogic.SESSION_TOKEN_INVALID_ERROR
							or e.errorCode == _ErrorLogic.USER_CREATE_CHARACTER_USER_NOT_FOUND

		if loginRequired == true then
			self:SetLogin()
		end
	end
	
	@ExecSpace("ClientOnly")
	@EventSender("LocalPlayer")
	handler HandleCreateCharacterCompleteEvent(CreateCharacterCompleteEvent e)
		_ScreenMessageLogic:PrivateMsg("캐릭터가 생성되었습니다")

		---@type LoginGroupComponent
		local LoginGroupCom = self._T["LoginGroupComponent"]
		if LoginGroupCom == nil then
			_GameServerLogic:Kick(_UserProxy:GetUid(), "LoginGroupComponent를 찾을 수 없습니다", KickReason.WorldError)
			return
		end

		LoginGroupCom.CharacterSelectionLayerCom:Setup()
		LoginGroupCom.CharacterSelectionLayerCom:SetSlot(e.newCharacter)
	end

	@ExecSpace("ClientOnly")
	@EventSender("LocalPlayer")
	handler HandleDeleteCharacterFailureEvent(DeleteCharacterFailureEvent e)
		_ErrorLogic:Throw(e.errorCode)

		-- 유저를 찾을 수 없다는 오류면 로그인 화면으로 이동
		local loginRequired = e.errorCode == _ErrorLogic.SESSION_TOKEN_INVALID_ERROR
							or e.errorCode == _ErrorLogic.USER_DELETE_CHARACTER_USER_NOT_FOUND

		if loginRequired == true then
			self:SetLogin()
		else
			_ScreenMessageLogic:PrivateMsg("캐릭터가 삭제에 실패하였습니다.")
			---@type LoginGroupComponent
			local LoginGroupCom = self._T["LoginGroupComponent"]
			if LoginGroupCom == nil then
				_GameServerLogic:Kick(_UserProxy:GetUid(), "LoginGroupComponent를 찾을 수 없습니다", KickReason.WorldError)
				return
			end

			LoginGroupCom.CharacterSelectionLayerCom:Setup()
		end
	end

	@ExecSpace("ClientOnly")
	@EventSender("LocalPlayer")
	handler HandleDeleteCharacterCompleteEvent(DeleteCharacterCompleteEvent e)
		_ScreenMessageLogic:PrivateMsg("캐릭터가 삭제되었습니다")

		---@type LoginGroupComponent
		local LoginGroupCom = self._T["LoginGroupComponent"]
		if LoginGroupCom == nil then
			_GameServerLogic:Kick(_UserProxy:GetUid(), "LoginGroupComponent를 찾을 수 없습니다", KickReason.WorldError)
			return
		end

		LoginGroupCom.CharacterSelectionLayerCom:Setup()
		LoginGroupCom.CharacterSelectionLayerCom:SetEmptySlot(e.slot)
	end

	@ExecSpace("ClientOnly")
	@EventSender("LocalPlayer")
	handler HandleRequestCharacterSelectAndPlayEvent(RequestCharacterSelectAndPlayEvent e)
		local params = {}
		params["slot"] = e.slot

		local transition = _TransitionLogic:Push(_TransitionLogic.Default)
		if transition ~= nil then
			local transitionEvent = TransitionEvent()
			transitionEvent.complete = function()
				_GameServerLogic:RequestTeleportToMap(_UserProxy:GetUid(), self.Entity, params)
			end
			transition:SendEvent(transitionEvent)
		else
			_GameServerLogic:RequestTeleportToMap(_UserProxy:GetUid(), self.Entity, params)
		end
	end

	@ExecSpace("ServerOnly")
	@EventSender("Self")
	handler HandleTeleportToMapEvent(TeleportToMapEvent e)
		if e.params == nil then
			return
		end

		if e.params["slot"] == nil then
			return
		end

		local slot = e.params["slot"]

		_UserProxy:SetSelectCharacter(slot, e.uid)
		_GameServerLogic:TeleportToMapForUser(e.uid, "GameplayMap")
	end

end
